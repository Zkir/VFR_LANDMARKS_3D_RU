# Настройки проекта для Gemini CLI

## Общая логика проекта
Проект является валидатором 3D моделей для объектов OpenStreetMap (OSM), сфокусированным на церквях и исторических зданиях в России.

Основной процесс управляется скриптом `run_validator.bat`:
1.  **Защита от повторного запуска:** Скрипт создает файл-блокировку (`work_folder\.lock`), чтобы предотвратить одновременный запуск нескольких экземпляров.
2.  **Очистка:** Удаляется содержимое `work_folder\00_planet.osm\` для обеспечения чистой обработки.
3.  **Обновление данных OSM:** Выполняется `make planet-update`, который загружает или обновляет исходные данные OSM.
4.  **Валидация и генерация данных:** Запускается `make`, который:
    *   Парсит и обрабатывает данные OSM с помощью скриптов из `OsmParser/`.
    *   Выполняет валидацию 3D моделей.
    *   Генерирует `.dat` и `.json` файлы для фронтенда.
5.  **Логирование:** Весь вывод команд `make` перенаправляется в `work_folder\log.txt`.
6.  **Веб-интерфейс:** Сгенерированные данные используются веб-сервером (запускаемым через `index.py` в `3dcheck/`), который динамически формирует HTML-страницы для отображения статистики и информации о зданиях.

## Создание 3D моделей
Проект использует два основных автоматизированных пайплайна для генерации 3D-моделей, которые затем отображаются на веб-интерфейсе:

1.  **Пайплайн Blender OSM:**
    *   Использует Blender (с аддоном Blender OSM и пользовательским патчем для крыш) для конвертации OSM-данных в 3D-модели.
    *   Процесс: `.osm` файлы (для каждого здания) -> `scripts/osm2blend.bat` -> `.obj` файлы -> `scripts/obj2x3d.py` -> `.x3d` файлы (хранятся в `3dcheck/models/`).

2.  **Пайплайн OSM2World:**
    *   Использует инструмент OSM2World для конвертации OSM-данных в 3D-модели.
    *   Процесс: `.osm` файлы (для каждого здания) -> `scripts/osm2gltf.bat` (использует OSM2World) -> `.x3d` файлы (хранятся в `3dcheck/models2/`).

Модели в формате `.x3d` отображаются на веб-страницах с помощью библиотеки X3DOM.

## Структура файлов
- Фронт-энд: `3dcheck/`
- Основная логика веб-страниц: `3dcheck/pages/`.
- Файлы с данными (для фронтенда): `3dcheck/data/quadrants/*.dat`.
- Файлы статистики в формате JSON: `3dcheck/data/stats/*.json`.
- Скрипты парсинга и обработки OSM: `OsmParser/`.
- Исполняемый файл для запуска всего процесса валидации: `run_validator.bat`.
- Пользовательские 3D модели: `Custom_models/` (содержат `.blend` и `.png` файлы).
- Пользовательские фасады: `Facades/` (содержат `.fac` и `.png` файлы, используются для сборки X-Plane).
- Конфигурация Blender: `blender-config/` (содержит `blender_start_up_file.zip` и `blender-osm-patch/`).

## Особенности данных
- `.dat` файлы являются текстовыми CSV с разделителем '|'. Они должны быть прочитаны с использованием функции `loadDatFile` из `mdlMisc.py`.
    *   Пример структуры `Quadrants.dat` (используется в `page_index.py`): `[Код региона, Название региона, Всего объектов, Объектов с 3D, Дата последнего обновления, Ошибки, Обновлено объектов, Обновлено объектов с 3D, Ошибочных объектов, Количество фото]`
    *   Пример структуры региональных `.dat` файлов (например, `RU-MOS.dat`, используется в `page_region.py`): `[Тип объекта, OSM ID, Широта (мин), Долгота (мин), Широта (макс), Долгота (макс), Название, Temples.ru ID, Тип здания, Размер, Высота, Цвет, Материал, Стиль, Год постройки, Wikipedia, Город, Район, Область, Есть 3D, Число частей, Дата последнего редактирования, Число ошибок, Есть фото]`
- `.json` файлы статистики (например, `building_type_stats.json`, `building_style_stats.json`) содержат агрегированные данные. Для получения общего количества объектов из этих файлов, необходимо просуммировать значения по ключу `"total"` для каждого элемента.

- mdlDBMetadata.py содержит константы для полей (QUADLIST_TOTAL_OBJECTS, QUADDATA_LAST_UPDATE_DATE), но константы используются не везде, вместо них используются волшебные числа. Это бага, волшебные числа можно смело менять на константы, с учетом той таблицы к которой они относятся.

### Известные проблемы
- Файлы `.dat` игнорируются в `.gitignore`, поэтому при работе с ними необходимо использовать `respect_git_ignore=False` в инструментах `list_directory` и `glob`.


## Часто используемые модули
- `mdlMisc.py`: Содержит общие вспомогательные функции, включая `loadDatFile` для чтения `.dat` файлов.
- `mdlClassify.py`: Содержит функции для классификации типов зданий и архитектурных стилей (например, `buildingTypeRus`, `achitectureStylesRus`).




## Установка и запуск
- **Установка зависимостей Python:**
    ```bash
    pip install -r requirements.txt
    ```
- **Запуск процесса валидации:**
    ```bash
    run_validator.bat
    ```
    Запускать его автоматически не надо, он занимает несколько часов. 
    
- **Просмотр веб-интерфейса:**
     Веб-сервер уже запущен по адресу http://localhost:8082, на нем можно тестировать получившиеся веб-страницы.

- Лог ошибок Apache находится в `c:\Apache24\logs\error.log`. Разрешаю его тебе читать.